{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
  * {
    margin: 0;
    padding: 0;
    border: 0;
    box-sizing: border-box;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    margin: 0;
    overflow-x: hidden;   /* ✅ no horizontal scroll */
  }

  body.dark-mode .dashboard-overview {
    background-color: #1a1a1a;
    color: #ffffff;
  }

  /* Dashboard container */
  .dashboard-overview {
    width: 95%;
    display: flex;
    flex-direction: column;
    gap: 30px;
    padding: 20px;
    margin-left: 115px;          /* ✅ space for sidebar */
    transition: margin-left 0.3s ease;
    overflow-x: hidden;          /* ✅ prevent horizontal */
    overflow-y: visible;         /* ✅ no inner vertical scroll */
  }

  /* When sidebar collapses */
  .sidebar.collapsed ~ .dashboard-overview {
    margin-left: 70px;
  }

  .head {
    color: black;
    font-weight: 500;
    font-size: 24px;
    margin-bottom: 20px;
  }

  body.dark-mode .head {
    color: #ffffff;
  }

  .stats-container,
  .charts-container,
  .bottom-section {
    width: 95%;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
  }

  /* ✅ Stats: 4 in a row */
  .stat-card {
    flex: 1 1 calc(25% - 20px);
    max-width: calc(25% - 20px);
    border-radius: 8px;
    border: 1px solid rgba(161, 161, 161, 0.2);
    background-color: rgba(247, 247, 247, 0.6);
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.08);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: transform 0.2s ease;
  }

  /* ✅ Charts: 3 in a row */
  .chart-card {
    flex: 1 1 calc(33.33% - 20px);
    max-width: calc(33.33% - 20px);
    border-radius: 8px;
    border: 1px solid rgba(161, 161, 161, 0.2);
    background-color: rgba(247, 247, 247, 0.6);
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.08);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: transform 0.2s ease;
  }

  .progress-card,
  .notifications-card {
    flex: 1 1 calc(50% - 20px);
    max-width: calc(50% - 20px);
    border-radius: 8px;
    border: 1px solid rgba(161, 161, 161, 0.2);
    background-color: rgba(247, 247, 247, 0.6);
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.08);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    transition: transform 0.2s ease;
  }

  .stat-card:hover,
  .chart-card:hover {
    transform: translateY(-5px);
  }

  body.dark-mode .stat-card,
  body.dark-mode .chart-card,
  body.dark-mode .progress-card,
  body.dark-mode .notifications-card {
    background-color: rgba(45, 45, 45, 0.6);
    border-color: rgba(161, 161, 161, 0.1);
    color: #ffffff;
  }

  .stat-value {
    color: #007b82;
    font-weight: 500;
    font-size: 32px;
  }

  .stat-label {
    font-weight: 500;
    font-size: 14px;
    color: #666;
  }

  body.dark-mode .stat-label {
    color: #aaa;
  }

  .chart-title {
    font-weight: 500;
    font-size: 18px;
    color: #333;
  }

  body.dark-mode .chart-title {
    color: #fff;
  }

  .chart-wrapper {
    width: 100%;
    height: 250px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .section-title {
    font-size: 20px;
    font-weight: 500;
    color: #333;
  }

  body.dark-mode .section-title {
    color: #ffffff;
  }

  .progress-bar {
    width: 100%;
    height: 20px;
    border-radius: 10px;
    background-color: #f1f1f1;
    position: relative;
    overflow: hidden;
  }

  body.dark-mode .progress-bar {
    background-color: #333;
  }

  .progress-fill {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background-color: #007b82;
    border-radius: 10px;
    transition: width 1.5s ease-in-out;
    width: 0%;
  }

  .progress-text {
    font-weight: 400;
    font-size: 16px;
    color: #666;
  }

  body.dark-mode .progress-text {
    color: #aaa;
  }

  .notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .notification-badge {
    padding: 6px 10px;
    border-radius: 8px;
    background-color: #007b82;
    color: white;
    font-size: 13px;
    font-weight: 500;
  }

  .notifications-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;    /* ✅ only this area scrolls */
    max-height: 120px;
    padding-right: 5px;
  }

  .notification-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .notification-message {
    font-size: 14px;
    color: #333;
    flex: 1;
  }

  body.dark-mode .notification-message {
    color: #eee;
  }

  .notification-time {
    color: #007b82;
    font-size: 13px;
    font-weight: 400;
    min-width: 100px;
    text-align: right;
  }

  /* Scrollbar styling */
  .notifications-list::-webkit-scrollbar {
    width: 5px;
  }
  .notifications-list::-webkit-scrollbar-track {
    background: transparent;
  }
  .notifications-list::-webkit-scrollbar-thumb {
    background: #007b82;
    border-radius: 10px;
  }
  body.dark-mode .notifications-list::-webkit-scrollbar-thumb {
    background: #00b0ba;
  }

  /* ✅ Responsive */
  @media (max-width: 1200px) {
    .stat-card {
      flex: 1 1 calc(50% - 20px);
      max-width: calc(50% - 20px);
    }
    .chart-card {
      flex: 1 1 calc(50% - 20px);
      max-width: calc(50% - 20px);
    }
    .progress-card,
    .notifications-card {
      flex: 1 1 100%;
      max-width: 100%;
    }
  }

  @media (max-width: 768px) {
    .stat-card,
    .chart-card {
      flex: 1 1 100%;
      max-width: 100%;
    }
  }
</style>

<div class="dashboard-overview">
  <h1 class="head">Dashboard Overview</h1>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-value" data-count="{{ total_users }}">0</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" data-count="{{ active_plans }}">0</div>
      <div class="stat-label">Active Plans</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" data-count="{{ expired_plans }}">0</div>
      <div class="stat-label">Expired Plans</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" data-count="{{ total_api_calls }}">0</div>
      <div class="stat-label">API Calls</div>
    </div>
  </div>

  <!-- Charts Section (3 side by side) -->
  <div class="charts-container">
    <div class="chart-card">
      <h3 class="chart-title">User Plans Distribution</h3>
      <div class="chart-wrapper">
        <canvas id="plansChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h3 class="chart-title">API Calls Usage</h3>
      <div class="chart-wrapper">
        <canvas id="apiChart"></canvas>
      </div>
    </div>
    <div class="chart-card">
      <h3 class="chart-title">Coupon Discounts</h3>
      <div class="chart-wrapper">
        <canvas id="couponsChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Bottom Section -->
  <div class="bottom-section">
    <div class="progress-card">
      <h3 class="section-title">API Usage Progress</h3>
      <div class="progress-bar">
        <div class="progress-fill" id="apiProgress" style="width: {{ api_progress_percent }}%;"></div>
      </div>
      <p class="progress-text" id="apiDesc">
        API calls: {{ total_api_calls }} of {{ api_goal }} Goal
      </p>
    </div>

    <div class="notifications-card">
      <div class="notifications-header">
        <h3 class="section-title">Recent Notifications</h3>
        {% if unread_count > 0 %}
        <div class="notification-badge">{{ unread_count }} new</div>
        {% endif %}
      </div>
      <div class="notifications-list" id="dashboard-notifications">
        {% if notifications %}
          {% for notification in notifications %}
          <div class="notification-item">
            <p class="notification-message">{{ notification.message }}</p>
            <span class="notification-time">{{ notification.created_at|timesince }} ago</span>
          </div>
          {% endfor %}
        {% else %}
        <div class="p-3 text-center">No notifications</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const plansData = {{ plans_data|safe }};
    const apiData = {{ api_data|safe }};
    const couponData = {{ coupon_data|safe }};

    // Animate counters
    document.querySelectorAll('.stat-value').forEach(counter => {
      const target = +counter.getAttribute('data-count');
      let count = 0, step = target / 60;
      function update() {
        count += step;
        if (count < target) {
          counter.innerText = Math.ceil(count);
          requestAnimationFrame(update);
        } else {
          counter.innerText = target;
        }
      }
      update();
    });

    const colors = ['#007B82', '#00B0BA', '#F89D14', '#E2E2E2'];

    new Chart(document.getElementById('plansChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(plansData),
        datasets: [{
          data: Object.values(plansData),
          backgroundColor: colors.slice(0, Object.keys(plansData).length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { display: true, position: 'bottom' } }
      }
    });

    new Chart(document.getElementById('apiChart'), {
      type: 'pie',
      data: {
        labels: Object.keys(apiData),
        datasets: [{
          data: Object.values(apiData),
          backgroundColor: colors.slice(0, Object.keys(apiData).length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true, position: 'bottom' } }
      }
    });

    new Chart(document.getElementById('couponsChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(couponData),
        datasets: [{
          data: Object.values(couponData),
          backgroundColor: colors.slice(0, Object.keys(couponData).length),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { display: true, position: 'bottom' } }
      }
    });
  });
</script>

{% endblock content %}
